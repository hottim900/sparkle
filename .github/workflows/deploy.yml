name: Deploy

on:
  workflow_run:
    workflows: [CI]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: self-hosted
    timeout-minutes: 10

    steps:
      - name: Pull latest code
        run: cd /home/tim/sparkle && git pull origin main

      - name: Install dependencies
        run: cd /home/tim/sparkle && npm ci

      - name: Build frontend
        run: cd /home/tim/sparkle && npm run build

      - name: Validate migrations against production DB
        run: |
          cd /home/tim/sparkle
          timeout 10 node --env-file=.env --import tsx -e "
            import './server/db/index.js';
            console.log('Migration validation passed');
            process.exit(0);
          " || {
            echo '❌ Migration validation failed — aborting deploy (old service still running)'
            exit 1
          }

      - name: Restart service
        run: sudo systemctl restart sparkle

      - name: Health check
        run: |
          for i in 1 2 3 4 5; do
            sleep 2
            if curl -sf http://localhost:3000/api/health; then
              echo "Deploy successful — health check passed"
              exit 0
            fi
            echo "Attempt $i failed, retrying..."
          done
          echo "Health check failed after 5 attempts"
          exit 1
